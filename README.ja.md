[English](./README.md)

# FADownloaderPerl
ネットワーク中からFlashAir SD-WLAN カードを自動探索してファイルのダウンロードを行うPerlスクリプトです。

## 使い方

```
使い方: perl fad.pl (オプション)…

オプション:

--net=(netspec)
   FlashAirカードを探索するために、あなたのLANネットワークのIPv4アドレスの最初の三つの数字を指定します。
   デフォルトは "192.168.1" です。

--df (folder)
--download-folder=(folder)
   ダウンロードした画像を保存するディレクトリのパスを指定します。
   デフォルトは "./download" です。

--rf (folder)
--record-folder=(folder)
   ファイルをダウンロード済みかどうか覚えておくためのディレクトリのパスを指定します。
   デフォルトは "./record" です。

-i (seconds)
--interval=(seconds)
   ファイルスキャンを行う時間間隔を秒数で指定します。
   デフォルトは5です。

-v
--verbose
   コンソールに出力する情報を冗長にします。
   デフォルトではセットされません。

--readonly
   "read only"属性がついていないファイルはダウンロードしません。
   デフォルトではセットされません。

--filetype=".jp* .raw"
   ダウンロード対象のファイル種別を空白区切りのリストで指定します。
   ファイル種別には ? と * のワイルドカードを指定できます。
   デフォルトは ".jp*" です。
```

## セットアップ
- Perlをインストールします。 https://www.perl.org/get.html
- cpanminusをインストールします。 https://metacpan.org/pod/App::cpanminus
- `cpanm Data::Dump AnyEvent::HTTP URI::Escape` を実行して、このアプリの依存関係をインストールします。
- このリポジトリから fad.pl をダウンロードします。
- FlashAirカードがSTAモードやインターネット同時接続モードを使うように設定します。このアプリを動かすPCから到達可能なWLANネットワークに接続するようにFlasfAirカードを設定します。
- あなたのWLANネットワークのアドレスを確認します。
- `perl fad.pl --net=192.168.1`を実行します。--net オプションの値を"あなたのWLANネットワークのIPv4アドレスの最初の三つの数字"に変更してください。

## FlashAirカード検出の挙動

- FlashAirカードを検出するため、このアプリは定期的にWLANネットワーク中の全てのアドレスにHTTPリクエストを送ります。

### 古い挙動 (--detection-udp でこの挙動を有効にします)
- このアプリは定期的に(APRリクエストの代わりに）WLANネットワーク中の全てのアドレスにUDPパケットを送ります。
- WLANネットワーク中の有効なアドレスを検出するため、このアプリは定期的に  `arp -a` コマンドを実行します。
- FlashAirカードを検出するため、このアプリは定期的にWLANネットワーク中の有効なアドレスにHTTPリクエストを送ります。

## ファイルダウンロードの挙動
- このアプリは定期的にFlashAirカード中のファイル一覧を取得します。
- hidden/system属性を持つファイル、ファイル名がファイル種別にマッチしないファイル、既にダウンロード済みのファイルは無視されます。
- このアプリはFlashAirカード中のファイルをダウンロードして "./download/{YYYYMMDD}/{file}" に保存します。
- このアプリは "./record/{YYYYMMDD}/{file}" に空のファイルを作成して、ファイルがダウンロード済みかどうかの確認に使います。
